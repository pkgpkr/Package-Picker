{% extends "webservice/base.html" %}

{% block title %}
    Recommendations
{% endblock %}

{% block body %}
<section class="section">
  <div class="container">
    <div class="content is-medium">
      <h2>RECOMMENDATIONS for `{{ repository_name }}`</h2>
      <br>
      <table>
        <tr>
          <td id="selected-category">Selected Category: </td>
          <td id="selected-category-input"><input type="text" id="categoryName" name="categoryName" disabled></td>
          <td><button id="categoryClear" class="button is-light" onclick="categoryClear()">Clear</button></td>
        </tr>
      </table>
      <div class="table-container">
        <table class="display-data-tables">
          <thead>
            <tr>
              <th>Name</th>
              <th>Category</th>
              <th>Downloads</th>
              <th>Rate</th>
              <th id="version-date-header">Version Date</th>
            </tr>
          </thead>
          <tbody>
            {% for recommendation in recommendations %}
              <tr>
                <td><a target="_blank" href="{{ recommendation.url }}">{{ recommendation.name }}</td>
                <td>
                  {% for keyword in recommendation.keywords %}
                  <div class="buttons" style="margin-bottom: 0; display:inline-block;">
                    <button class="button is-info is-light is-small is-hovered" onclick="categoryClick('{{ keyword }}')">{{ keyword }}</button>
                  </div>
                  {% endfor %}
                </td>
                <td>{{ recommendation.average_downloads }}</td>
                <td>{{ recommendation.rate }}</td>
                <td>{{ recommendation.date }}</td>
              </tr>
            {% endfor %}
          </<tbody>
        </table>
      </div>
      <div class="recommendation-filter">
        <p class="control has-icons-right">
          <input id="recommendationFilter" class="input is-small" type="text" placeholder="Search">
          <span class="icon is-small is-right">
            <i class="fas fa-search"></i>
          </span>
        </p>
      </div>
    </div>
  </div>
</section>
<script>
  // Fetch all the npm metadata for the packages shown in the current page
  function fetchPage() {
    var table = $('.display-data-tables').DataTable();
      var indices = table.rows({ page: "current" }).indexes();
      var majorVersionRegex = /pkg:npm\/.*@\d+/

      for (var i = 0; i <= indices.length; ++i) {
        (function (rowIndex) {
          var row = table.row(rowIndex).data();

          // Make sure the row has not already been loaded
          if (row[1]) {
            return;
          }
          row[2] = '...';
          row[4] = '...';

          // Make sure we can strip out the package name
          var found = row[0].match(majorVersionRegex);
          if (found == 0) {
            return;
          }

          // Fetch data and load asyncronously
          $.ajax({
            type: 'GET',
            url: '/metadata/' + found[0],
            dataType: 'json',
            success: function (data) {

              // Set keywords
              if (data['keywords']) {
                var keywordHtml = "";
                for (var keyword of data['keywords']) {
                  keywordHtml += '<div class="buttons" style="margin-bottom: 0; display:inline-block;">' +
                                '<button class="button is-info is-light is-small is-hovered" onclick="categoryClick(\'' + keyword + '\')">' + keyword + '</button>' +
                                '</div>'
                } 
                row[1] = keywordHtml;
              }

              // Set average downloads
              row[2] = data['average_downloads'];

              // Set date
              row[4] = data['date'];

              // Redraw the row
              table.row(rowIndex).data(row).invalidate("data").draw(false);
            }
          });
        })(indices[i]);
      }
  }

  // Events to trigger a metadata fetch
  $('.display-data-tables').on('init.dt', function (e, settings) {
      fetchPage();
  });
  $('.display-data-tables').on('page.dt', function (e, settings) {
      fetchPage();
  });
</script>
{% endblock %}
